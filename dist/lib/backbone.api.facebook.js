/**
 * @name backbone.api.facebook
 * Backbone API: Facebook
 *
 * Version: 0.7.0 (Sun, 07 Dec 2014 08:37:36 GMT)
 * Source: http://github.com/backbone-api/facebook
 *
 * @author makesites
 * Initiated by: Makis Tracend (@tracend)
 * Distributed through [Makesites.org](http://makesites.org)
 *
 * @cc_on Copyright ï¿½ Makesites.org
 * @license Released under the MIT
 */

(function(e){if(typeof define=="function"&&define.amd){var t=["jquery","underscore","backbone"];define(t,e)}else if(typeof module=="object"&&module&&typeof module.exports=="object")module.exports=e;else{var n=window.jQuery||window.Zepto||window.vQuery;e(n,window._,window.Backbone,window.APP)}})(function(e,t,n,r){var i=typeof r!="undefined",s="https://graph.facebook.com",o=new n.Model({api:s,appId:!1,uri:!1});o.Models={},o.Collections={},o.Views={};var u=function(e,t,n){var r=this.url instanceof Function?this.url():this.url,i={},s=this.getToken();s&&(r instanceof Object?r.access_token=s:r+=r.search(/\?/)>-1?"&access_token="+s:"?access_token="+s);var o={read:"get",create:"post",update:"put","delete":"delete"};FB.api(r,o[e],function(e){var t=e.data||e;n.success(t)})},a=function(){return this.options&&this.options.access_token?this.options.access_token:t.isUndefined(d.get("accessToken"))?!1:d.get("accessToken")},f=n.Model.extend({options:{access_token:!1},initialize:function(e,n){n=n||{},this.options=t.extend(this.options,n),n.fetch&&this.fetch()},fetch:function(e,t,r){var i=this;this.getToken()?n.Model.prototype.fetch.call(i,e,t,r):this.options.auth?FB.getLoginStatus(function(s){s.status=="connected"&&(d.set(s.authResponse),n.Model.prototype.fetch.call(i,e,t,r))}):n.Model.prototype.fetch.call(i,e,t,r)},sync:u,getToken:a});o.Models.User=f.extend({url:function(){return o.get("api")+"/"+this.get("id")},options:{auth:!1},defaults:{id:0}}),o.Models.Feed=f.extend({defaults:{}}),o.Models.Post=f.extend({defaults:{method:"feed",link:"",picture:"",name:"",caption:"",description:""}}),o.Models.Page=f.extend({defaults:{method:"oauth",client_id:!1,redirect_uri:""},isFan:function(e){return e=e||"me()",(new c({id:this.id,uid:e})).fetch()}}),o.Models.Tab=f.extend({url:function(){return o.get("api")+"/"+this.page+"/tabs/app_"+this.id},defaults:{},initialize:function(e,t){this.page=e.page,this.id=o.get("appId")}}),o.Models.Link=f.extend({defaults:{url:window.location.href,normalized_url:"",share_count:0,like_count:0,comment_count:0,total_count:0,commentsbox_count:0,comments_fbid:0,click_count:0},url:function(){return{method:"fql.query",query:"SELECT url,normalized_url,share_count,like_count,comment_count,total_count,commentsbox_count,comments_fbid,click_count FROM link_stat WHERE url ='"+this.get("url")+"'"}},parse:function(e){return e instanceof Array?e.shift():e}}),o.Models.Login=f.extend({defaults:{method:"oauth",client_id:!1}}),o.Models.AddToPage=f.extend({defaults:{method:"pagetab"}}),o.Models.Me=o.Models.User.extend({defaults:{id:"me"},options:{auth:!1,scope:[],autosync:!0,protocol:location.protocol},oauth:null,initialize:function(){var e=this;return FB.Event.subscribe("auth.authResponseChange",function(t){e.onLoginStatusChange(t)}),n.API.Facebook.Models.User.prototype.initialize.apply(this,arguments)},login:function(e){e=e||function(){},FB.login(e,{scope:this.options.scope.join(",")})},logout:function(){FB.logout()},onLoginStatusChange:function(e){if(this.options.auth===e.status)return!1;var t;e.status==="not_authorized"?t="facebook:unauthorized":e.status==="connected"?(t="facebook:connected",this.request=FB.getAuthResponse(),this.oauth={access_token:this.request.accessToken,expiry:(new Date).getTime()+this.request.expiresIn},this.options.autosync===!0&&this.fetch()):t="facebook:disconnected",this.trigger(t,this,e),this.options.auth=e.status}}),o.Models.WebPage=f.extend({defaults:{shares:0,comments:0,type:"website",is_scraped:!1},options:{},url:function(){return o.get("api")+"/?ids="+this.options.page},parse:function(e){var t={};for(var n in e){t=e[n];break}return e=t,e}});var l=n.Model.extend({}),c=f.extend({url:function(){return{method:"fql.query",query:"select uid from page_fan where uid="+this.options.uid+" and page_id="+this.options.id}},parse:function(e){return{fan:!t.isEmpty(e.data)}}}),h=n.Collection.extend({options:{access_token:!1},initialize:function(e,n){n=n||{},this.options=t.extend(this.options,n),n.fetch&&this.fetch()},fetch:function(e,t,r){var i=this;this.getToken()?n.Collection.prototype.fetch.call(i):FB.getLoginStatus(function(e){e.status=="connected"&&(d.set(e.authResponse),n.Collection.prototype.fetch.call(i))})},sync:u,parse:function(e){var n=t.map(e,function(e){return e.uid&&(e.id=e.uid,delete e.uid),e});return n},getToken:a});o.Collections.Friends=h.extend({model:o.Models.User,url:function(){return{method:"fql.query",query:"Select name, uid from user where is_app_user = 1 and uid in (select uid2 from friend where uid1 = me()) order by concat(first_name,last_name) asc"}}}),o.Collections.Feed=h.extend({options:{},model:o.Models.Feed,url:function(){var e={method:"fql.query",query:"select message,description,attachment,created_time from stream where source_id ='"+this.id+"' limit "+this.num};return this.options.access_token&&(e.access_token=this.options.access_token),e},initialize:function(e,t){this.id=t.id||!1,this.user=t.user||null,this.num=t.num||10,t.fetch&&this.fetch()}});var p=n.View.extend({template:FB.ui,initialize:function(e){return e=e||{},e.callback&&(this.callback=e.callback),this.render()},render:function(){return this.template(this.model.toJSON(),this.callback),this},callback:function(){}});o.Views.Post=p.extend({callback:function(e){}}),o.Views.Login=p.extend({initialize:function(e){return this.model=new n.API.Facebook.Models.Login({client_id:n.API.Facebook.get("appId")}),p.prototype.initialize.call(this,e)},callback:function(e){typeof e!="undefined"?e.session?top.location.href=this.model.get("redirect_uri"):(console.log("no session"),window.location.reload()):console.log("denied access")}}),o.Views.AddToPage=p.extend({initialize:function(e){return this.model=new n.API.Facebook.Models.AddToPage,p.prototype.initialize.call(this,e)}});var d=new l;return n.API=n.API||{},n.API.Facebook=o,i&&(r.API=r.API||{},r.API.Facebook=o),typeof window=="object"&&typeof window.document=="object"&&(window.Backbone=n,i&&(window.APP=r),window.Facebook||(window.Facebook=o)),o});