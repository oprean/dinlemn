/*! backbone-nested-models - 1.0.0 */

!function(e,t){"object"==typeof exports?module.exports=t(require("backbone")):"function"==typeof define&&define.amd?define(["backbone"],function(n){return e.returnExportsGlobal=t(n)}):e.returnExportsGlobal=t(e.Backbone)}(this,function(e){var t=e.Model,n=e.Collection;e.Model.prototype.setRelation=function(e,r,i){var s=this.attributes[e],o=this.idAttribute||"id",u=[],a=[];if(i.unset&&s&&delete s.parent,this.relations&&_.has(this.relations,e)){if(s&&s instanceof n)return r instanceof n||r instanceof Array?(r=r.models||r,u=_.clone(r),s.each(function(e,t){if("undefined"!=typeof e[o]){var n=_.find(r,function(t){return t[o]===e[o]});n?(e.set(n.toJSON?n.toJSON():n),u.splice(t,1)):a.push(e)}}),_.each(a,function(e){s.remove(e)}),s.add(u)):s.each(function(e){r[o]===e[o]?e.set(r):s.remove(e)}),s;if(r instanceof t&&(r=r.toJSON()),s&&s instanceof t)return s.set(r),s;i._parent=this,r=new this.relations[e](r,i),r.parent=this}return r},e.Model.prototype.set=function(e,t,n){var r,i,s,o,u,a,f,l;if(null==e)return this;if("object"==typeof e?(i=e,n=t):(i={})[e]=t,n||(n={}),!this._validate(i,n))return!1;s=n.unset,u=n.silent,o=[],a=this._changing,this._changing=!0,a||(this._previousAttributes=_.clone(this.attributes),this.changed={}),l=this.attributes,f=this._previousAttributes,this.idAttribute in i&&(this.id=i[this.idAttribute]);for(r in i)t=i[r],t=this.setRelation(r,t,n),_.isEqual(l[r],t)||o.push(r),_.isEqual(f[r],t)?delete this.changed[r]:this.changed[r]=t,s?delete l[r]:l[r]=t;if(!u){o.length&&(this._pending=!0);for(var c=0,h=o.length;h>c;c++)this.trigger("change:"+o[c],this,l[o[c]],n)}if(a)return this;if(!u)for(;this._pending;)this._pending=!1,this.trigger("change",this,n);return this._pending=!1,this._changing=!1,this},e.Model.prototype.toJSON=function(){var e=_.clone(this.attributes);return _.each(this.relations,function(t,n){e[n]=_.has(e,n)?e[n].toJSON():(new t).toJSON()}),e},e.Model.prototype.clone=function(){return new this.constructor(this.toJSON())},e.Collection.prototype.resetRelations=function(t){_.each(this.models,function(n){_.each(n.relations,function(r,i){n.get(i)instanceof e.Collection&&n.get(i).trigger("reset",n,t)})})},e.Collection.prototype.reset=function(e,t){t||(t={});for(var n=0,r=this.models.length;r>n;n++)this._removeReference(this.models[n]);return t.previousModels=this.models,this._reset(),this.add(e,_.extend({silent:!0},t)),t.silent||(this.trigger("reset",this,t),this.resetRelations(t)),this}});