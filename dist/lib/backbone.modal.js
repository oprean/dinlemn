(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e},r=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};(function(e){return typeof define=="function"&&define.amd?define(["underscore","backbone","exports"],e):typeof exports=="object"?e(require("underscore"),require("backbone"),exports):e(_,Backbone,{})})(function(t,i,s){return s=function(s){function o(){this.triggerCancel=e(this.triggerCancel,this),this.triggerSubmit=e(this.triggerSubmit,this),this.triggerView=e(this.triggerView,this),this.clickOutside=e(this.clickOutside,this),this.checkKey=e(this.checkKey,this),this.rendererCompleted=e(this.rendererCompleted,this),this.args=Array.prototype.slice.apply(arguments),i.View.prototype.constructor.apply(this,this.args),this.setUIElements()}return n(o,s),o.prototype.prefix="bbm",o.prototype.animate=!0,o.prototype.keyControl=!0,o.prototype.showViewOnRender=!0,o.prototype.render=function(e){var n,r;n=this.serializeData();if(!e||t.isEmpty(e))e=0;return this.$el.addClass(""+this.prefix+"-wrapper"),this.modalEl=i.$("<div />").addClass(""+this.prefix+"-modal"),typeof this.templateHelpers=="function"&&t.extend(n,this.templateHelpers()),this.template&&this.modalEl.html(this.buildTemplate(this.template,n)),this.$el.html(this.modalEl),this.viewContainer?(this.viewContainerEl=this.modalEl.find(this.viewContainer),this.viewContainerEl.addClass(""+this.prefix+"-modal__views")):this.viewContainerEl=this.modalEl,i.$(":focus").blur(),((r=this.views)!=null?r.length:void 0)>0&&this.showViewOnRender&&this.openAt(e),typeof this.onRender=="function"&&this.onRender(),this.delegateModalEvents(),this.$el.fadeIn&&this.animate?(this.modalEl.css({opacity:0}),this.$el.fadeIn({duration:100,complete:this.rendererCompleted})):this.rendererCompleted(),this},o.prototype.rendererCompleted=function(){var e;return this.keyControl&&(i.$("body").on("keyup.bbm",this.checkKey),i.$("body").on("mouseup.bbm",this.clickOutside)),this.modalEl.css({opacity:1}).addClass(""+this.prefix+"-modal--open"),typeof this.onShow=="function"&&this.onShow(),(e=this.currentView)!=null?typeof e.onShow=="function"?e.onShow():void 0:void 0},o.prototype.setUIElements=function(){var e;this.template=this.getOption("template"),this.views=this.getOption("views"),(e=this.views)!=null&&(e.length=t.size(this.views)),this.viewContainer=this.getOption("viewContainer"),this.animate=this.getOption("animate");if(t.isUndefined(this.template)&&t.isUndefined(this.views))throw new Error("No template or views defined for Backbone.Modal");if(this.template&&this.views&&t.isUndefined(this.viewContainer))throw new Error("No viewContainer defined for Backbone.Modal")},o.prototype.getOption=function(e){if(!e)return;return this.options&&r.call(this.options,e)>=0&&this.options[e]!=null?this.options[e]:this[e]},o.prototype.serializeData=function(){var e;return e={},this.model&&(e=t.extend(e,this.model.toJSON())),this.collection&&(e=t.extend(e,{items:this.collection.toJSON()})),e},o.prototype.delegateModalEvents=function(){var e,n,r,i,s,o,u;this.active=!0,e=this.getOption("cancelEl"),s=this.getOption("submitEl"),s&&this.$el.on("click",s,this.triggerSubmit),e&&this.$el.on("click",e,this.triggerCancel),u=[];for(n in this.views)t.isString(n)&&n!=="length"?(r=n.match(/^(\S+)\s*(.*)$/),o=r[1],i=r[2],u.push(this.$el.on(o,i,this.views[n],this.triggerView))):u.push(void 0);return u},o.prototype.undelegateModalEvents=function(){var e,n,r,i,s,o,u;this.active=!1,e=this.getOption("cancelEl"),s=this.getOption("submitEl"),s&&this.$el.off("click",s,this.triggerSubmit),e&&this.$el.off("click",e,this.triggerCancel),u=[];for(n in this.views)t.isString(n)&&n!=="length"?(r=n.match(/^(\S+)\s*(.*)$/),o=r[1],i=r[2],u.push(this.$el.off(o,i,this.views[n],this.triggerView))):u.push(void 0);return u},o.prototype.checkKey=function(e){if(this.active)switch(e.keyCode){case 27:return this.triggerCancel(e);case 13:return this.triggerSubmit(e)}},o.prototype.clickOutside=function(e){if(i.$(e.target).hasClass(""+this.prefix+"-wrapper")&&this.active)return this.triggerCancel()},o.prototype.buildTemplate=function(e,n){var r;return typeof e=="function"?r=e:r=t.template(i.$(e).html()),r(n)},o.prototype.buildView=function(e,n){var r;if(!e)return;return n&&t.isFunction(n)&&(n=n()),t.isFunction(e)?(r=new e(n||this.args[0]),r instanceof i.View?{el:r.render().$el,view:r}:{el:e(n||this.args[0])}):{view:e,el:e.$el}},o.prototype.triggerView=function(e){var n,r,i,s,o,u,a;e!=null&&typeof e.preventDefault=="function"&&e.preventDefault(),s=e.data,r=this.buildView(s.view,s.viewOptions);if(this.currentView){this.previousView=this.currentView;if((a=s.openOptions)!=null?!a.skipSubmit:!void 0){if((typeof (o=this.previousView).beforeSubmit=="function"?o.beforeSubmit():void 0)===!1)return;typeof (u=this.previousView).submit=="function"&&u.submit()}}this.currentView=r.view||r.el,n=0;for(i in this.views)s.view===this.views[i].view&&(this.currentIndex=n),n++;return s.onActive&&(t.isFunction(s.onActive)?s.onActive(this):t.isString(s.onActive)&&this[s.onActive].call(this,s)),this.shouldAnimate?this.animateToView(r.el):(this.shouldAnimate=!0,this.$(this.viewContainerEl).html(r.el))},o.prototype.animateToView=function(e){var t,n,r,s,o,u,a;return s={position:"relative",top:-9999,left:-9999},o=i.$("<tester/>").css(s),o.html(this.$el.clone().css(s)),i.$("tester").length!==0?i.$("tester").replaceWith(o):i.$("body").append(o),this.viewContainer?t=o.find(this.viewContainer):t=o.find("."+this.prefix+"-modal"),t.removeAttr("style"),r=t.outerHeight(),t.html(e),n=t.outerHeight(),r===n?(this.$(this.viewContainerEl).html(e),typeof (u=this.currentView).onShow=="function"&&u.onShow(),(a=this.previousView)!=null?typeof a.destroy=="function"?a.destroy():void 0:void 0):this.animate?(this.$(this.viewContainerEl).css({opacity:0}),this.$(this.viewContainerEl).animate({height:n},100,function(t){return function(){var n,r;return t.$(t.viewContainerEl).css({opacity:1}).removeAttr("style"),t.$(t.viewContainerEl).html(e),typeof (n=t.currentView).onShow=="function"&&n.onShow(),(r=t.previousView)!=null?typeof r.destroy=="function"?r.destroy():void 0:void 0}}(this))):this.$(this.viewContainerEl).css({height:n}).html(e)},o.prototype.triggerSubmit=function(e){var t,n;e!=null&&e.preventDefault();if(this.beforeSubmit&&this.beforeSubmit()===!1)return;if(this.currentView&&this.currentView.beforeSubmit&&this.currentView.beforeSubmit()===!1)return;return!this.submit&&((t=this.currentView)!=null?!t.submit:!void 0)&&!this.getOption("submitEl")?this.triggerCancel():((n=this.currentView)!=null&&typeof n.submit=="function"&&n.submit(),typeof this.submit=="function"&&this.submit(),this.regionEnabled?this.trigger("modal:destroy"):this.destroy())},o.prototype.triggerCancel=function(e){e!=null&&e.preventDefault();if(this.beforeCancel&&this.beforeCancel()===!1)return;return typeof this.cancel=="function"&&this.cancel(),this.regionEnabled?this.trigger("modal:destroy"):this.destroy()},o.prototype.destroy=function(){var e;return i.$("body").off("keyup.bbm",this.checkKey),i.$("body").off("mouseup.bbm",this.clickOutside),i.$("tester").remove(),typeof this.onDestroy=="function"&&this.onDestroy(),this.shouldAnimate=!1,this.modalEl.addClass(""+this.prefix+"-modal--destroy"),e=function(e){return function(){var t;return(t=e.currentView)!=null&&typeof t.remove=="function"&&t.remove(),e.remove()}}(this),this.$el.fadeOut&&this.animate?(this.$el.fadeOut({duration:200}),t.delay(function(){return e()},200)):e()},o.prototype.openAt=function(e){var n,r,i,s,o;t.isNumber(e)?n=e:t.isNumber(e._index)&&(n=e._index),i=0;for(s in this.views)if(s!=="length")if(t.isNumber(n))i===n&&(o=this.views[s]),i++;else if(t.isObject(e))for(r in this.views[s])e[r]===this.views[s][r]&&(o=this.views[s]);return o&&(this.currentIndex=t.indexOf(this.views,o),this.triggerView({data:t.extend(o,{openOptions:e})})),this},o.prototype.next=function(e){e==null&&(e={});if(this.currentIndex+1<this.views.length)return this.openAt(t.extend(e,{_index:this.currentIndex+1}))},o.prototype.previous=function(e){e==null&&(e={});if(this.currentIndex-1<this.views.length-1)return this.openAt(t.extend(e,{_index:this.currentIndex-1}))},o}(i.View),i.Modal=s,i.Modal})}).call(this);